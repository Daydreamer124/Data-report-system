import markdown
from bs4 import BeautifulSoup
import os
import argparse
from pathlib import Path
import random
import urllib.parse
import json
import re

def parse_markdown(md_path):
    """
    è§£æMarkdownæ–‡ä»¶ï¼Œæå–ç« èŠ‚å’Œå›¾è¡¨ä¿¡æ¯
    ç›´æ¥ä½¿ç”¨æ›´é«˜æ•ˆçš„ç›´æ¥è§£ææ–¹æ³•
    """
    #print(f"\nå¼€å§‹è§£æMarkdownæ–‡ä»¶: {md_path}")
    return parse_markdown_direct(md_path)

def parse_markdown_direct(md_path):
    """ä½¿ç”¨ç›´æ¥è§£æMarkdownçš„æ–¹å¼æå–æ•°æ®ç»“æ„"""
    #print(f"\nä½¿ç”¨ç›´æ¥è§£ææ–¹å¼æå–Markdownå†…å®¹: {md_path}")
    
    with open(md_path, 'r', encoding='utf-8') as f:
        md_content = f.read()

    # è·å–Markdownæ–‡ä»¶æ‰€åœ¨ç›®å½•
    md_dir = os.path.dirname(os.path.abspath(md_path))
    # æå–è¿­ä»£ç›®å½•è·¯å¾„ (ä¾‹å¦‚: /path/to/iteration_1/)
    iteration_dir = md_dir
    # æŸ¥æ‰¾vegalite_configsç›®å½•
    vegalite_configs_dir = os.path.join(iteration_dir, "vegalite_configs")
    print(f"Vega-Liteé…ç½®ç›®å½•: {vegalite_configs_dir}")

    # åˆå§‹åŒ–æ•°æ®ç»“æ„
    sections = []
    current_section = None
    current_caption = ""
    in_chart_group = False
    current_group_charts = []
    current_group_caption = ""
    current_subsection = None
    summary_content = ""
    intro_text = []  # ç”¨äºå­˜å‚¨ç« èŠ‚å¼•è¨€/è¿‡æ¸¡æ–‡æœ¬
    query_from_title = ""  # ç”¨äºå­˜å‚¨ä»æ ‡é¢˜ä¸­æå–çš„æŸ¥è¯¢
    report_abstract = ""  # ç”¨äºå­˜å‚¨æŠ¥å‘Šæ‘˜è¦
    report_conclusion = ""  # ç”¨äºå­˜å‚¨æŠ¥å‘Šç»“è®º
    
    # æŒ‰è¡Œå¤„ç†Markdownå†…å®¹
    lines = md_content.split('\n')
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        
        # è¯†åˆ«ä¸»æ ‡é¢˜ (# å¼€å¤´) - ä»ä¸­æå–æŸ¥è¯¢
        if line.startswith('# ') and not query_from_title:
            query_from_title = line[2:].strip()  # ç§»é™¤"# "å‰ç¼€
            print(f"ä»æ ‡é¢˜ä¸­æå–æŸ¥è¯¢: {query_from_title}")
            i += 1
            continue
        
        # è¯†åˆ«æ‘˜è¦éƒ¨åˆ† (## æ‘˜è¦)
        elif line.startswith('## æ‘˜è¦') or line.startswith('## Abstract') or line.startswith('## Summary') or line.startswith('## Key Abstract'):
            print(f"å‘ç°æ‘˜è¦éƒ¨åˆ†: {line}")
            # æ”¶é›†æ‘˜è¦å†…å®¹ç›´åˆ°ä¸‹ä¸€ä¸ªç« èŠ‚æ ‡é¢˜
            abstract_lines = []
            j = i + 1
            while j < len(lines) and not (lines[j].strip().startswith('## ') and 
                                        not lines[j].strip().startswith('## æ‘˜è¦') and 
                                        not lines[j].strip().startswith('## Abstract') and 
                                        not lines[j].strip().startswith('## Summary') and
                                        not lines[j].strip().startswith('## Key Abstract')):
                if lines[j].strip():  # åªæ·»åŠ éç©ºè¡Œ
                    abstract_lines.append(lines[j].strip())
                j += 1
            
            if abstract_lines:
                report_abstract = " ".join(abstract_lines)
                print(f"æ”¶é›†æ‘˜è¦å†…å®¹: {report_abstract[:100]}...")
            
            # è·³è¿‡å·²å¤„ç†çš„è¡Œ
            i = j - 1
        
        # è¯†åˆ«ç»“è®ºéƒ¨åˆ† (## brief_conclusion)
        elif line.startswith('## brief_conclusion') or line.startswith('## ç»“è®º') or line.startswith('## Conclusion'):
            print(f"å‘ç°ç»“è®ºéƒ¨åˆ†: {line}")
            # æ”¶é›†ç»“è®ºå†…å®¹ç›´åˆ°æ–‡ä»¶ç»“æŸ
            conclusion_lines = []
            j = i + 1
            while j < len(lines):
                if lines[j].strip():  # åªæ·»åŠ éç©ºè¡Œ
                    conclusion_lines.append(lines[j].strip())
                j += 1
            
            if conclusion_lines:
                report_conclusion = " ".join(conclusion_lines)
                print(f"æ”¶é›†ç»“è®ºå†…å®¹: {report_conclusion[:100]}...")
            
            # è·³è¿‡å·²å¤„ç†çš„è¡Œ
            i = j - 1
        
        # è¯†åˆ«ç« èŠ‚æ ‡é¢˜ (## å¼€å¤´ï¼Œä½†æ’é™¤æ‘˜è¦)
        elif line.startswith('## ') and not line.startswith('## æ‘˜è¦') and not line.startswith('## Abstract') and not line.startswith('## Summary') and not line.startswith('## Key Abstract'):
            # ä¿å­˜ä¹‹å‰çš„ç« èŠ‚ï¼ˆå¦‚æœæœ‰ï¼‰
            if current_section:
                # æ·»åŠ æ‰€æœ‰æ”¶é›†åˆ°çš„ç« èŠ‚æ€»ç»“
                if summary_content:
                    current_section["summary"] = summary_content
                    print(f"è®¾ç½®ç« èŠ‚æ‘˜è¦: {current_section['summary'][:50]}...")
                    summary_content = ""
                sections.append(current_section)
            
            # æå–ç« èŠ‚æ ‡é¢˜
            title = line[3:].strip()
            # å¤„ç†å­—å…¸æ ¼å¼çš„æ ‡é¢˜
            if title.startswith("{'title': '") and title.endswith("'}"):
                title = title[len("{'title': '"):-2]
            
            # åˆ›å»ºæ–°ç« èŠ‚
            current_section = {
                "title": title,
                "charts": [],
                "summary": "",
                "key_insights": [],
                "subsections": [],
                "intro_text": ""  # æ·»åŠ å¼•è¨€/è¿‡æ¸¡æ–‡æœ¬å­—æ®µ
            }
            current_caption = ""
            in_chart_group = False
            current_group_charts = []
            current_group_caption = ""
            current_subsection = None
            summary_content = ""
            intro_text = []  # é‡ç½®å¼•è¨€æ–‡æœ¬
            
            print(f"å‘ç°ç« èŠ‚: {title}")
        
        # è¯†åˆ«Chapter Summaryéƒ¨åˆ†
        elif line.startswith("### Chapter Summary") or line.startswith("### ç« èŠ‚æ€»ç»“"):
            # å½“æ‰¾åˆ°ä¸€ä¸ªç« èŠ‚æ€»ç»“æ—¶ï¼Œæ”¶é›†æ‰€æœ‰å†…å®¹ç›´åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜
            summary_lines = []
            j = i + 1
            while j < len(lines) and not lines[j].strip().startswith('#') and j < len(lines):
                if lines[j].strip():  # åªæœ‰éç©ºè¡Œæ‰æ·»åŠ 
                    summary_lines.append(lines[j].strip())
                j += 1
            
            if summary_lines and current_section:
                summary_content = " ".join(summary_lines)
                # æ³¨æ„ï¼šä¸è¦ç«‹å³è®¾ç½®current_section["summary"]ï¼Œè€Œæ˜¯åœ¨ç« èŠ‚ç»“æŸæ—¶è®¾ç½®
                #print(f"æ”¶é›†ç« èŠ‚æ‘˜è¦ï¼ˆå°†åœ¨ç« èŠ‚æœ«å°¾æ˜¾ç¤ºï¼‰: {summary_content[:50]}...")
                # è·³è¿‡å·²å¤„ç†çš„è¡Œ
                i = j - 1
        
        # è¯†åˆ«å­ç« èŠ‚æ ‡é¢˜ (### å¼€å¤´ï¼Œä½†ä¸æ˜¯Chapter Summary)
        elif line.startswith('### ') and not line.startswith("### Chapter Summary") and not line.startswith("### ç« èŠ‚æ€»ç»“"):
            # å¦‚æœæ­¤æ—¶æœ‰æ”¶é›†åˆ°çš„å¼•è¨€æ–‡æœ¬ï¼Œåˆ™ä¿å­˜åˆ°å½“å‰ç« èŠ‚
            if intro_text and current_section:
                current_section["intro_text"] = "\n".join(intro_text)
                #print(f"è®¾ç½®ç« èŠ‚å¼•è¨€: {current_section['intro_text'][:50]}...")
                intro_text = []
            
            subsection_title = line[4:].strip()
            current_subsection = {
                "title": subsection_title,
                "content": []
            }
            if current_section:
                current_section["subsections"].append(current_subsection)
            #print(f"å‘ç°å­ç« èŠ‚: {subsection_title}")
        
        # è¯†åˆ«æ™®é€šæ®µè½æ–‡æœ¬
        elif line and not line.startswith('>') and not line.startswith('<!--') and not line.startswith('!['):
            if current_subsection:
                # å¦‚æœæœ‰å½“å‰å­ç« èŠ‚ï¼Œæ·»åŠ åˆ°å­ç« èŠ‚å†…å®¹
                if current_subsection.get("content"):
                    current_subsection["content"].append(line)
                else:
                    current_subsection["content"] = [line]
            elif current_section and not current_subsection:
                # å¦‚æœæ²¡æœ‰å½“å‰å­ç« èŠ‚ä½†æœ‰å½“å‰ç« èŠ‚ï¼Œæ­¤ä¸ºç« èŠ‚å¼•è¨€/è¿‡æ¸¡æ–‡æœ¬
                intro_text.append(line)
        
        # è¯†åˆ«å¼•ç”¨å— (> å¼€å¤´)ï¼Œå¤„ç†ä¸ºcaption
        elif line.startswith('>'):
            caption_text = line[1:].strip()
            
            # æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦ä¹Ÿæ˜¯å¼•ç”¨å— (> å¼€å¤´)ï¼Œå¦‚æœæ˜¯åˆ™åˆå¹¶
            j = i + 1
            while j < len(lines) and lines[j].strip().startswith('>'):
                caption_text += '\n' + lines[j][1:].strip()
                j += 1
                i += 1  # è·³è¿‡å·²å¤„ç†çš„è¡Œ
            
            # æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦æ˜¯key pointçš„è¿ç»­éƒ¨åˆ†(ä¸ä»¥>å¼€å¤´ä½†ä»¥key pointå¼€å¤´)
            while j < len(lines) and lines[j].strip() and (lines[j].strip().startswith('key point') or 
                  (caption_text.endswith('key point') and not lines[j].strip().startswith('>'))):
                caption_text += '\n' + lines[j].strip()
                j += 1
                i += 1  # è·³è¿‡å·²å¤„ç†çš„è¡Œ
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å›¾è¡¨ç»„å¼€å§‹
            k = j
            while k < len(lines) and not lines[k].strip():
                k += 1  # è·³è¿‡ç©ºè¡Œ
                
            is_next_group_start = k < len(lines) and "<!-- chart-group-start -->" in lines[k].strip()
            
            if in_chart_group or is_next_group_start:
                current_group_caption = caption_text
                #print(f"è®¾ç½®å›¾è¡¨ç»„caption: {caption_text[:30]}...")
            else:
                current_caption = caption_text
                #print(f"è®¾ç½®å•å›¾è¡¨caption: {caption_text[:30]}...")
        
        # è¯†åˆ«å›¾è¡¨ç»„å¼€å§‹æ ‡è®°
        elif '<!-- chart-group-start -->' in line:
            in_chart_group = True
            current_group_charts = []
            #print("æ£€æµ‹åˆ°å›¾è¡¨ç»„å¼€å§‹æ ‡è®°")
                
        # è¯†åˆ«å›¾è¡¨ç»„ç»“æŸæ ‡è®°
        elif '<!-- chart-group-end -->' in line:
            if in_chart_group and current_group_charts and current_section:
                # åˆ›å»ºå›¾è¡¨ç»„å¯¹è±¡
                chart_group = {
                    "is_chart_group": True,
                    "charts": current_group_charts,
                    "group_caption": current_group_caption
                }
                
                # æ·»åŠ åˆ°ç« èŠ‚
                current_section["charts"].append(chart_group)
                #print(f"æ·»åŠ å›¾è¡¨ç»„ï¼ŒåŒ…å« {len(current_group_charts)} ä¸ªå›¾è¡¨, caption: '{current_group_caption[:50]}...'")
            
            in_chart_group = False
            current_group_charts = []
            current_group_caption = ""
        
        # è¯†åˆ«å›¾ç‰‡ (![alt](src) æ ¼å¼)
        elif line.startswith('![') and '](' in line and line.endswith(')'):
            # æå–å›¾ç‰‡ä¿¡æ¯
            alt_start = line.find('![') + 2
            alt_end = line.find('](')
            src_start = alt_end + 2
            src_end = line.rfind(')')
            
            if alt_start < alt_end and src_start < src_end:
                alt_text = line[alt_start:alt_end]
                src = line[src_start:src_end]
                
                # æå–æ–‡ä»¶å
                img_filename = os.path.basename(src)
                
                # ç›´æ¥ä½¿ç”¨ç›¸å¯¹äºchartsæ–‡ä»¶å¤¹çš„è·¯å¾„
                relative_img_path = "charts/" + img_filename
                
                # æå–å›¾ç‰‡æ–‡ä»¶åï¼ˆä¸åŒ…å«è·¯å¾„å’Œæ‰©å±•åï¼‰
                img_name, img_ext = os.path.splitext(img_filename)
                
                # æŸ¥æ‰¾å¯¹åº”çš„Vega-Liteé…ç½®æ–‡ä»¶
                vegalite_config_path = os.path.join(vegalite_configs_dir, f"{img_name}.json")
                
                # åˆ›å»ºå›¾è¡¨ä¿¡æ¯
                chart_info = {
                    "img": relative_img_path,  # åªä¿å­˜ç›¸å¯¹è·¯å¾„
                    "img_filename": img_filename,  # ä¿å­˜æ–‡ä»¶å
                    "caption": current_caption if not in_chart_group else "",
                    "alt_text": alt_text,
                    "subsection_title": current_subsection["title"] if current_subsection else ""
                }
                
                # å¦‚æœæ‰¾åˆ°å¯¹åº”çš„Vega-Liteé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ åˆ°chart_infoä¸­
                if os.path.exists(vegalite_config_path):
                    chart_info["vegalite_config"] = vegalite_config_path
                    chart_info["is_vegalite"] = True  # æ ‡è®°ä¸ºVega-Liteå›¾è¡¨
                    print(f"æ‰¾åˆ°Vega-Liteé…ç½®æ–‡ä»¶: {vegalite_config_path}")
                else:
                    print(f"æœªæ‰¾åˆ°Vega-Liteé…ç½®æ–‡ä»¶: {vegalite_config_path}")
                
                # æ·»åŠ åˆ°é€‚å½“çš„ä½ç½®
                if in_chart_group:
                    chart_info["in_group"] = True
                    current_group_charts.append(chart_info)
                    print(f"æ·»åŠ å›¾ç‰‡åˆ°ç»„: {src}, vegalite: {chart_info.get('is_vegalite', False)}")
                elif current_section:
                    current_section["charts"].append(chart_info)
                    print(f"æ·»åŠ å•ä¸ªå›¾ç‰‡: {src}, vegalite: {chart_info.get('is_vegalite', False)}")
        
        i += 1
    
    # æ·»åŠ æœ€åä¸€ä¸ªç« èŠ‚
    if current_section:
        # ä¿å­˜æ”¶é›†çš„å¼•è¨€æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
        if intro_text:
            current_section["intro_text"] = "\n".join(intro_text)
            #print(f"è®¾ç½®æœ€åç« èŠ‚å¼•è¨€: {current_section['intro_text'][:50]}...")
        
        # æ·»åŠ æ‰€æœ‰æ”¶é›†åˆ°çš„ç« èŠ‚æ€»ç»“
        if summary_content:
            current_section["summary"] = summary_content
            #print(f"è®¾ç½®æœ€åç« èŠ‚æ‘˜è¦: {current_section['summary'][:50]}...")
        sections.append(current_section)
    
    # æ‰“å°ç»Ÿè®¡ä¿¡æ¯
    if report_abstract:
        print(f"\nè§£æå®Œæˆ: æ‰¾åˆ°æŠ¥å‘Šæ‘˜è¦å’Œ {len(sections)} ä¸ªç« èŠ‚")
        print(f"æŠ¥å‘Šæ‘˜è¦: {report_abstract[:100]}...")
    else:
        print(f"\nè§£æå®Œæˆ: æ‰¾åˆ° {len(sections)} ä¸ªç« èŠ‚ï¼ˆæ— æ‘˜è¦ï¼‰")
    
    for i, section in enumerate(sections, 1):
        charts_count = len(section.get("charts", []))
        subsections_count = len(section.get("subsections", []))
        has_intro = bool(section.get("intro_text", ""))
        #print(f"ç« èŠ‚ {i}: '{section.get('title', 'æ— æ ‡é¢˜')}' - åŒ…å« {charts_count} ä¸ªå›¾è¡¨/å›¾è¡¨ç»„, {subsections_count} ä¸ªå­ç« èŠ‚, æœ‰å¼•è¨€: {has_intro}")
        
        # æ‰“å°å­ç« èŠ‚ä¿¡æ¯
        for k, subsection in enumerate(section.get("subsections", []), 1):
            print(f"  - å­ç« èŠ‚ {k}: '{subsection.get('title', 'æ— æ ‡é¢˜')}'")
        
        for j, chart in enumerate(section.get("charts", []), 1):
            if isinstance(chart, dict) and chart.get("is_chart_group", False):
                group_charts = chart.get("charts", [])
                group_caption = chart.get("group_caption", "")
                vegalite_charts = sum(1 for c in group_charts if c.get("is_vegalite", False))
                #print(f"  - å›¾è¡¨ç»„ {j}: åŒ…å« {len(group_charts)} ä¸ªå›¾è¡¨ ({vegalite_charts} ä¸ªVega-Lite), caption: '{group_caption[:30]}...'")
            else:
                img_path = chart.get("img", "")
                caption = chart.get("caption", "")
                is_vegalite = chart.get("is_vegalite", False)
                #print(f"  - å›¾è¡¨ {j}: {chart.get('img_filename', '')}, caption: '{caption[:30]}...', vegalite: {is_vegalite}")
        
        # æ‰“å°ç« èŠ‚æ‘˜è¦ä¿¡æ¯
        if section.get("summary"):
            print(f"  - æ‘˜è¦: '{section.get('summary', '')[:50]}...'")
        else:
            print(f"  - æ— æ‘˜è¦")
    
    return sections, query_from_title, report_abstract

# è¾…åŠ©å‡½æ•°ï¼šå°†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦è½¬æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œé¿å…åœ¨æŸ¥æ‰¾æ–‡ä»¶æ—¶å‡ºé”™
def escape_filename(name):
    if not name:
        return "unnamed"
    # å°†ç‰¹æ®Šå­—ç¬¦è½¬æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œä¿ç•™å­—æ¯ã€æ•°å­—å’Œå¸¸è§æ ‡ç‚¹
    import re
    return re.sub(r'[^\w\-\.]', '_', name)

# è¾…åŠ©å‡½æ•°ï¼šå°†ç»å¯¹è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
def convert_to_relative_path(path):
    """
    å°†è·¯å¾„è½¬æ¢ä¸ºé€‚åˆHTMLä¸­ä½¿ç”¨çš„ç›¸å¯¹è·¯å¾„ï¼Œå¤„ç†ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
    """
    if not path:
        return ""
        
    # ä½¿ç”¨URLç¼–ç å¤„ç†ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
    # å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥è¿”å›ç¼–ç åçš„è·¯å¾„
    encoded_path = path.replace(" ", "%20")
    return encoded_path

# æ·»åŠ ä¸€ä¸ªé€šç”¨å‡½æ•°æ¥å¤„ç†Vega-Liteé…ç½®
def prepare_vegalite_config(sections):
    """
    ä¸ºsectionsä¸­çš„æ‰€æœ‰å›¾è¡¨å‡†å¤‡Vega-Liteé…ç½®
    è¿”å›ï¼š
    - chart_configs: åŒ…å«æ‰€æœ‰å›¾è¡¨é…ç½®çš„åˆ—è¡¨
    - chart_id_counter: ç”¨äºç”Ÿæˆå”¯ä¸€å›¾è¡¨IDçš„è®¡æ•°å™¨
    """
    # ç”¨äºå­˜å‚¨æ‰€æœ‰å›¾è¡¨é…ç½®çš„æ•°ç»„
    chart_configs = []
    
    # ä¸ºæ¯ä¸ªå›¾è¡¨åˆ›å»ºå”¯ä¸€çš„ID
    chart_id_counter = 0
    
    for section in sections:
        for chart_item in section.get("charts", []):
            # æ£€æŸ¥æ˜¯å¦æ˜¯å›¾è¡¨ç»„
            if isinstance(chart_item, dict) and chart_item.get("is_chart_group", False):
                # å¤„ç†å›¾è¡¨ç»„å†…çš„æ‰€æœ‰å›¾è¡¨
                for group_chart in chart_item.get("charts", []):
                    process_chart_config(group_chart, chart_configs, chart_id_counter)
                    if "chart_id" in group_chart:
                        chart_id_counter += 1
            else:
                # å¤„ç†å•ä¸ªå›¾è¡¨
                process_chart_config(chart_item, chart_configs, chart_id_counter)
                if "chart_id" in chart_item:
                    chart_id_counter += 1
    
    return chart_configs, chart_id_counter

def process_chart_config(chart, chart_configs, chart_id_counter):
    """å¤„ç†å•ä¸ªå›¾è¡¨çš„é…ç½®"""
    vegalite_config_path = chart.get("vegalite_config", "")
    img_path = chart.get("img", "")
    
    if vegalite_config_path and os.path.exists(vegalite_config_path):
        # å¦‚æœæœ‰é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨Vega-Liteæ¸²æŸ“
        chart_id = f"vegalite_chart_{chart_id_counter}"
        
        # è¯»å–JSONé…ç½®æ–‡ä»¶å†…å®¹
        try:
            with open(vegalite_config_path, 'r', encoding='utf-8') as f:
                vegalite_spec = json.load(f)
            
            # ä¿®æ”¹Vega-Liteè§„æ ¼ï¼Œç¡®ä¿å®ƒèƒ½è‡ªé€‚åº”å®¹å™¨å®½åº¦
            vegalite_spec["width"] = "container"
            vegalite_spec["height"] = "container"
            
            # ä¼˜åŒ–yè½´æ ‡é¢˜æ˜¾ç¤º
            if "encoding" in vegalite_spec:
                if "y" in vegalite_spec["encoding"]:
                    # åªæœ‰å½“é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®šaxis.titleæ—¶æ‰è®¾ç½®
                    y_encoding = vegalite_spec["encoding"]["y"]
                    if "axis" not in y_encoding or "title" not in y_encoding["axis"]:
                        y_field = y_encoding.get("field", "")
                        if "Purchase_Amount__USD_" in y_field:
                            if "axis" not in y_encoding:
                                y_encoding["axis"] = {}
                            y_encoding["axis"]["title"] = "Purchase Amount (USD)"
                    
                    # æ·»åŠ å­—ä½“å¤§å°è®¾ç½®
                    if "axis" in y_encoding:
                        y_encoding["axis"]["titleFontSize"] = 14
                        y_encoding["axis"]["labelFontSize"] = 12
            
            # æ·»åŠ autosizeå±æ€§ç¡®ä¿é€‚åº”å®¹å™¨
            vegalite_spec["autosize"] = {
                "type": "fit",
                "contains": "padding",
                "resize": True
            }
            
            # æ£€æµ‹å›¾è¡¨ç±»å‹ï¼Œä¸ºä¸åŒç±»å‹çš„å›¾è¡¨è®¾ç½®ä¸åŒçš„è¾¹è·
            chart_type = ""
            if "mark" in vegalite_spec:
                if isinstance(vegalite_spec["mark"], dict):
                    chart_type = vegalite_spec["mark"].get("type", "")
                else:
                    chart_type = vegalite_spec["mark"]
            
            # ç‰¹æ®Šå¤„ç†çƒ­åŠ›å›¾
            if chart_type == "rect" and "Promo code usage by category" in vegalite_config_path:
                print(f"å‘ç°çƒ­åŠ›å›¾: {vegalite_config_path}")
                # å¼ºåˆ¶è®¾ç½®å›ºå®šé«˜åº¦ï¼Œç¡®ä¿çƒ­åŠ›å›¾æ˜¾ç¤ºå®Œæ•´
                vegalite_spec["width"] = 500
                vegalite_spec["height"] = 300
                # ç¡®ä¿çƒ­åŠ›å›¾çš„æ–‡æœ¬å¯è§
                if "encoding" in vegalite_spec and "text" in vegalite_spec["encoding"]:
                    if "mark" in vegalite_spec:
                        if isinstance(vegalite_spec["mark"], str):
                            vegalite_spec["mark"] = {
                                "type": "rect",
                                "tooltip": True
                            }
                        elif isinstance(vegalite_spec["mark"], dict):
                            vegalite_spec["mark"]["tooltip"] = True
                    
                    # æ·»åŠ æ ‡ç­¾å±‚æ¥æ˜¾ç¤ºé¢‘ç‡æ•°å­—
                    vegalite_spec["layer"] = [
                        {"mark": "rect"},
                        {
                            "mark": {
                                "type": "text",
                                "color": "white",
                                "font": "sans-serif",
                                "fontSize": 14,
                                "fontWeight": "bold"
                            },
                            "encoding": {
                                "text": {"field": "Frequency", "type": "quantitative"},
                                "color": {
                                    "condition": {
                                        "test": "datum.Frequency < 10",
                                        "value": "black"
                                    },
                                    "value": "white"
                                }
                            }
                        }
                    ]
                    
                # ä¸ºçƒ­åŠ›å›¾è®¾ç½®æ›´å¤§çš„è¾¹è·
                if "config" not in vegalite_spec:
                    vegalite_spec["config"] = {}
                if "padding" not in vegalite_spec["config"]:
                    vegalite_spec["config"]["padding"] = {}
                
                vegalite_spec["config"]["padding"] = {
                    "left": 80,
                    "bottom": 50,
                    "top": 50,
                    "right": 30
                }
            
            # ä¸ºæŸ±çŠ¶å›¾å’Œç›´æ–¹å›¾è®¾ç½®æ›´å¤§çš„è¾¹è·
            elif chart_type in ["bar", "histogram"]:
                # è®¾ç½®è¶³å¤Ÿå¤§çš„å·¦ä¾§å’Œåº•éƒ¨è¾¹è·
                if "config" not in vegalite_spec:
                    vegalite_spec["config"] = {}
                if "padding" not in vegalite_spec["config"]:
                    vegalite_spec["config"]["padding"] = {}
                
                vegalite_spec["config"]["padding"] = {
                    "left": 50,  # å¢åŠ å·¦ä¾§è¾¹è·ï¼Œç¡®ä¿yè½´æ ‡ç­¾æ˜¾ç¤º
                    "bottom": 30, # å¢åŠ åº•éƒ¨è¾¹è·ï¼Œç¡®ä¿xè½´æ ‡ç­¾æ˜¾ç¤º
                    "top": 60,    # ä¸ºå›¾ä¾‹ä¿ç•™ç©ºé—´
                    "right": 20   # å³ä¾§è¾¹è·
                }
            else:
                # å…¶ä»–å›¾è¡¨ç±»å‹ä½¿ç”¨æ ‡å‡†è¾¹è·
                if "config" not in vegalite_spec:
                    vegalite_spec["config"] = {}
                if "padding" not in vegalite_spec["config"]:
                    vegalite_spec["config"]["padding"] = {}
                
                vegalite_spec["config"]["padding"] = {
                    "left": 20,
                    "bottom": 20,
                    "top": 60,  # ä¸ºå›¾ä¾‹ä¿ç•™ç©ºé—´
                    "right": 20
                }
            
            # æ”¹è¿›xè½´æ ‡ç­¾æ˜¾ç¤º
            if "encoding" in vegalite_spec:
                # å¦‚æœæœ‰xè½´ç¼–ç ï¼Œæ”¹è¿›å…¶æ ‡ç­¾çš„æ˜¾ç¤º
                if "x" in vegalite_spec["encoding"]:
                    # æ£€æŸ¥æ˜¯å¦æ˜¯åä¹‰å‹æ•°æ®
                    if vegalite_spec["encoding"]["x"].get("type") == "nominal":
                        # æ·»åŠ è½´é…ç½®ä»¥æ”¹å–„æ ‡ç­¾æ˜¾ç¤º
                        vegalite_spec["encoding"]["x"]["axis"] = {
                            "labelAngle": 0,  # æ ‡ç­¾ä¸æ—‹è½¬
                            "labelOverlap": False,  # ä¸å…è®¸æ ‡ç­¾é‡å 
                            "labelLimit": 150  # å¢åŠ æ ‡ç­¾æ–‡æœ¬é•¿åº¦é™åˆ¶
                        }
                
                # å¤„ç†å›¾ä¾‹é…ç½®ï¼Œé¿å…ä¸å›¾è¡¨é‡å 
                if "color" in vegalite_spec["encoding"]:
                    # ç¡®ä¿å›¾ä¾‹ä½ç½®åˆç†
                    vegalite_spec["encoding"]["color"]["legend"] = {
                        "orient": "top",  # å°†å›¾ä¾‹æ”¾åœ¨é¡¶éƒ¨
                        "direction": "horizontal",  # æ°´å¹³æ’åˆ—å›¾ä¾‹é¡¹
                        "titlePadding": 10,
                        "labelLimit": 200,
                        "symbolSize": 100
                    }
            
            # ç¡®ä¿é…ç½®åŒ…å«å¿…è¦çš„é…ç½®é¡¹
            if "config" not in vegalite_spec:
                vegalite_spec["config"] = {}
            
            # æ·»åŠ axisé…ç½®ä»¥æ”¹å–„æ‰€æœ‰åæ ‡è½´çš„æ˜¾ç¤º
            if "axis" not in vegalite_spec["config"]:
                vegalite_spec["config"]["axis"] = {}
            
            # ç¡®ä¿åæ ‡è½´æ ‡ç­¾ä¸ä¼šè¢«æˆªæ–­
            vegalite_spec["config"]["axis"].update({
                "labelLimit": 200,  # å¢åŠ æ‰€æœ‰æ ‡ç­¾çš„æ–‡æœ¬é•¿åº¦é™åˆ¶
                "labelFontSize": 12,  # æ ‡ç­¾å­—ä½“å¤§å°
                "titleFontSize": 14,  # åæ ‡è½´æ ‡é¢˜å­—ä½“å¤§å°
                "labelPadding": 8    # æ ‡ç­¾ä¸è½´çº¿çš„è·ç¦»
            })
            
            # è·å–ç¼–ç åçš„ç›¸å¯¹è·¯å¾„
            relative_img_path = convert_to_relative_path(img_path)
            
            # ä¿å­˜é…ç½®ä¿¡æ¯
            chart_configs.append({
                "chartId": chart_id,
                "vegaliteSpec": vegalite_spec,
                "imgPath": relative_img_path
            })
            
            # åœ¨å›¾è¡¨å¯¹è±¡ä¸Šæ·»åŠ chart_idå±æ€§ï¼Œä»¥ä¾¿æ¨¡æ¿å‡½æ•°ä½¿ç”¨
            chart["chart_id"] = chart_id
            # æ ‡è®°ä¸ºVega-Liteå›¾è¡¨
            chart["is_vegalite"] = True
            
            print(f"å·²å¤„ç†Vega-Liteé…ç½®: {os.path.basename(vegalite_config_path)} -> chart_id: {chart_id}")
            
        except Exception as e:
            print(f"è¯»å–Vega-Liteé…ç½®æ–‡ä»¶å¤±è´¥: {vegalite_config_path}")
            print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
            print(f"ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼")

# ç”ŸæˆVega-Liteæ¸²æŸ“è„šæœ¬
def generate_vegalite_script(chart_configs):
    """
    æ ¹æ®å›¾è¡¨é…ç½®ç”ŸæˆVega-Liteæ¸²æŸ“è„šæœ¬
    """
    if not chart_configs:
        return ""
        
    chart_script = """
    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        console.log('åˆå§‹åŒ–æ‰€æœ‰Vega-Liteå›¾è¡¨...');
        
        // é€šç”¨é…ç½®
        const vegaOptions = {
            renderer: 'canvas',
            actions: false, // ç¦ç”¨æ‰€æœ‰å¯¼å‡ºåŠŸèƒ½æŒ‰é’®
            downloadFileName: 'chart',
            config: {
                axis: {
                    labelFontSize: 12,
                    titleFontSize: 13,
                    labelOverlap: true,
                    labelLimit: 200,
                    labelPadding: 8,
                    grid: true,
                    gridColor: '#f0f0f0',
                    tickCount: 5
                },
                legend: {
                    labelFontSize: 12,
                    titleFontSize: 13,
                    orient: 'top',
                    direction: 'horizontal',
                    symbolSize: 80,
                    labelLimit: 250,
                    padding: 10,
                    offset: 5
                },
                title: {
                    fontSize: 14,
                    fontWeight: 'bold',
                    anchor: 'middle',
                    font: 'sans-serif'
                },
                view: {
                    stroke: 'transparent',
                    strokeWidth: 0,
                    continuousHeight: 300,
                    continuousWidth: 400
                },
                range: {
                    category: ['#4169E1', '#FF6347', '#32CD32', '#FFD700', '#9370DB', '#4682B4', '#FF7F50', '#66CDAA']
                },
                mark: {
                    tooltip: true,
                    clip: true,
                    fontSize: 12,
                    font: 'sans-serif'
                },
                bar: {
                    cornerRadius: 0,
                    cornerRadiusTopLeft: 3,
                    cornerRadiusTopRight: 3
                },
                autosize: {
                    type: 'fit',
                    contains: 'padding',
                    resize: true
                },
                padding: {left: 10, right: 10, top: 60, bottom: 10}
            }
        };
        
        // æ·»åŠ è‡ªå®šä¹‰CSSæ ·å¼ï¼Œä¿®å¤å›¾ä¾‹é—®é¢˜
        const styleEl = document.createElement('style');
        styleEl.textContent = `
            .chart-container {
                position: relative;
                min-height: 450px !important;
                overflow: visible !important;
            }
            .vega-embed {
                width: 100%;
                height: 100%;
                position: relative;
                overflow: visible !important;
            }
            /* ç¡®ä¿å›¾ä¾‹ä¸ä¼šæº¢å‡ºå®¹å™¨ */
            .vega-embed .vega-bindings {
                position: absolute;
                top: 5px;
                right: 5px;
            }
            /* å›¾ä¾‹æ ·å¼ä¼˜åŒ– */
            .vega-embed .role-legend {
                transform: translate(0, -40px) !important;
            }
            .vega-embed .role-legend-entry .role-legend-symbol {
                fill-opacity: 0.8 !important;
            }
            .vega-embed .role-legend-entry:hover .role-legend-symbol {
                fill-opacity: 1 !important;
                stroke-width: 1.5;
            }
            /* ç¡®ä¿åæ ‡è½´æ ‡ç­¾å¯è§ */
            .vega-embed .role-axis-label {
                font-weight: normal;
                font-size: 12px;
            }
            /* ç¡®ä¿ç›´æ–¹å›¾å’ŒæŸ±çŠ¶å›¾å®Œå…¨æ˜¾ç¤º */
            .vega-embed .mark-rect {
                shape-rendering: crispEdges;
            }
            /* å¢åŠ å›¾è¡¨è§†å›¾åŒºåŸŸçš„å†…è¾¹è· */
            .vega-embed .role-frame {
                overflow: visible !important;
            }
        `;
        document.head.appendChild(styleEl);
    """
    
    # æ·»åŠ æ‰€æœ‰å›¾è¡¨é…ç½®å¹¶åˆå§‹åŒ–
    for i, config in enumerate(chart_configs):
        # å°†Pythonå­—å…¸è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        chart_id = config['chartId']
        json_str = json.dumps(config['vegaliteSpec'])
        chart_script += f"""
        // å›¾è¡¨ {i+1}: {chart_id}
        (function() {{
            const chartId = '{chart_id}';
            const element = document.getElementById(chartId);
            if (element) {{
                console.log('æ­£åœ¨æ¸²æŸ“å›¾è¡¨:', chartId);
                const vegaSpec = {json_str};
                
                // ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿçš„é«˜åº¦
                element.style.minHeight = '450px';
                
                // ä¸ºçƒ­åŠ›å›¾å¢åŠ é¢å¤–é«˜åº¦
                if (chartId === 'vegalite_chart_6') {{
                    console.log('è®¾ç½®çƒ­åŠ›å›¾ç‰¹æ®Šé«˜åº¦:', chartId);
                    element.style.minHeight = '500px';
                    element.style.height = '500px';
                    // ç¡®ä¿çˆ¶å®¹å™¨ä¹Ÿæœ‰è¶³å¤Ÿçš„é«˜åº¦
                    const parent = element.closest('.chart-group-item');
                    if (parent) {{
                        parent.style.minHeight = '520px';
                    }}
                    // å¢åŠ çˆ¶å®¹å™¨çš„å®½åº¦
                    const gridContainer = element.closest('.chart-group-grid');
                    if (gridContainer) {{
                        gridContainer.style.minHeight = '520px';
                    }}
                }}
                
                vegaEmbed('#' + chartId, vegaSpec, vegaOptions)
                    .then(function(result) {{
                        console.log('å›¾è¡¨æ¸²æŸ“æˆåŠŸ:', chartId);
                        window.chartInstances = window.chartInstances || {{}};
                        window.chartInstances[chartId] = result;
                        
                        // æ£€æŸ¥å›¾ä¾‹ä½ç½®ï¼Œé¿å…é‡å 
                        setTimeout(() => {{
                            const legendElements = element.querySelectorAll('.role-legend');
                            if (legendElements.length > 0) {{
                                // å¼ºåˆ¶å°†å›¾ä¾‹ç§»åˆ°é¡¶éƒ¨
                                legendElements.forEach(legend => {{
                                    // è·å–å½“å‰transform
                                    const currentTransform = legend.getAttribute('transform');
                                    if (currentTransform && currentTransform.includes('translate')) {{
                                        // æå–å½“å‰xåæ ‡
                                        const match = currentTransform.match(/translate\\\\(([^,]+),([^)]+)\\\\)/);
                                        if (match) {{
                                            const x = parseFloat(match[1]);
                                            // å¼ºåˆ¶å°†å›¾ä¾‹ç§»åˆ°é¡¶éƒ¨ï¼Œyåæ ‡è®¾ä¸º-40
                                            const newTransform = 'translate(' + x + ',-40)';
                                            legend.setAttribute('transform', newTransform);
                                        }}
                                    }}
                                }});
                            }}
                            
                            // å»¶è¿Ÿè°ƒæ•´å›¾è¡¨å¤§å°ï¼Œç¡®ä¿å®Œå…¨æ¸²æŸ“
                            setTimeout(() => {{
                                if (result && result.view) {{
                                    // å¼ºåˆ¶é‡æ–°è°ƒæ•´å¤§å°å¹¶æ¸²æŸ“
                                    result.view.resize().run();
                                    console.log('å·²è°ƒæ•´å›¾è¡¨å¤§å°:', chartId);
                                }}
                            }}, 300);
                        }}, 500);
                    }})
                    .catch(function(error) {{
                        console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', chartId, error);
                        const fallbackImg = element.getAttribute('data-fallback');
                        if (fallbackImg) {{
                            console.log('ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡:', fallbackImg);
                            const img = document.createElement('img');
                            img.src = fallbackImg;
                            img.alt = 'å›¾è¡¨';
                            img.style.width = '100%';
                            img.style.height = 'auto';
                            element.innerHTML = '';
                            element.appendChild(img);
                        }}
                    }});
            }} else {{
                console.warn('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨:', chartId);
            }}
        }})();
        """
    
    chart_script += """
        // é€‚åº”çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', function() {
            if (window.chartInstances) {
                Object.values(window.chartInstances).forEach(function(chart) {
                    if (chart && chart.view) {
                        chart.view.resize().run();
                    }
                });
            }
        });
    });
    """
    
    return chart_script

def fill_template(sections, template_type="dashboard", query="", report_abstract=""):
    """æ ¹æ®ç« èŠ‚æ•°æ®å¡«å……HTMLæ¨¡æ¿ï¼Œç”ŸæˆæŠ¥å‘Š"""
    if template_type == "dashboard":
        return generate_dashboard_template(sections, query, report_abstract)

def highlight_keywords(text, keywords=None):
    """
    å¯¹æ–‡æœ¬ä¸­çš„å…³é”®è¯è¿›è¡Œé«˜äº®å¤„ç†
    
    å‚æ•°:
    - text: è¦å¤„ç†çš„æ–‡æœ¬
    - keywords: å…³é”®è¯åˆ—è¡¨ï¼Œå¦‚æœä¸ºNoneåˆ™ä½¿ç”¨é»˜è®¤å…³é”®è¯
    
    è¿”å›:
    - å¤„ç†åçš„æ–‡æœ¬ï¼Œå¸¦æœ‰HTMLé«˜äº®æ ‡è®°
    """
    if not text:
        return ""
    
    # å¦‚æœæ²¡æœ‰æä¾›å…³é”®è¯ï¼Œä½¿ç”¨é»˜è®¤å…³é”®è¯
    if keywords is None:
        keywords = [
            "å¢é•¿", "ä¸‹é™", "ä¸Šå‡", "è¶‹åŠ¿", "æ˜¾è‘—", "æ˜æ˜¾", 
            "çªå‡º", "é‡è¦", "å…³é”®", "å¼‚å¸¸", "é«˜äº", "ä½äº",
            "æœ€é«˜", "æœ€ä½", "å¢åŠ ", "å‡å°‘", "å˜åŒ–", "ç¨³å®š",
            "æ³¢åŠ¨", "é›†ä¸­", "åˆ†æ•£", "æå€¼", "outlier", "å¼‚å¸¸å€¼"
        ]
    
    from html import escape
    
    # å…ˆè¿›è¡ŒHTMLè½¬ä¹‰ï¼Œé¿å…æ³¨å…¥
    escaped_text = escape(text)
    
    # å¯¹æ¯ä¸ªå…³é”®è¯è¿›è¡Œé«˜äº®å¤„ç†
    for keyword in keywords:
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå¤§å°å†™ä¸æ•æ„Ÿçš„æ›¿æ¢
        import re
        pattern = re.compile(re.escape(keyword), re.IGNORECASE)
        escaped_text = pattern.sub(f'<span class="highlight">{keyword}</span>', escaped_text)
    
    return escaped_text

def generate_dashboard_template(sections, query="", report_abstract=""):
    from html import escape
    
    # å¤„ç†å›¾è¡¨é…ç½®ï¼Œä½¿ç”¨Vega-Lite
    chart_configs, chart_id_counter = prepare_vegalite_config(sections)
    
    # è¾“å‡ºé…ç½®æƒ…å†µ
    print(f"ç”Ÿæˆäº† {len(chart_configs)} ä¸ªVega-Liteå›¾è¡¨é…ç½®")
    
    # ç”Ÿæˆä»ªè¡¨ç›˜å›¾è¡¨é¢æ¿
    panels_html = ""
    
    # æ·»åŠ æŸ¥è¯¢å±•ç¤ºä¿¡æ¯
    instruction_html = f'''
    <div class="instruction-card">
        <div class="instruction-icon">ğŸ”</div>
        <div class="instruction-content">
            <h3>ç”¨æˆ·æŸ¥è¯¢</h3>
            <p class="query-text">{escape(query) if query else "æ•°æ®åˆ†ææŠ¥å‘Š"}</p>
        </div>
    </div>
    '''
    
    # æ·»åŠ æ‘˜è¦å®¹å™¨ï¼ˆå¦‚æœæœ‰æ‘˜è¦ï¼‰
    abstract_html = ""
    if report_abstract:
        abstract_html = f'''
        <div class="abstract-container">
            <h2 class="abstract-title">æ‘˜è¦</h2>
            <div class="abstract-content">
                <p>{highlight_keywords(report_abstract)}</p>
        </div>
    </div>
    '''
    
    # ç”Ÿæˆç« èŠ‚å¯¼èˆª
    toc_html = '<div class="toc-container">\n<h3>ç›®å½•</h3>\n<ul class="toc-list">\n'
    for i, section in enumerate(sections, 1):
        title = section.get("title", "")
        toc_html += f'<li><a href="#section-{i}" class="toc-link">{i}. {escape(title)}</a></li>\n'
        
        # æ·»åŠ å­ç« èŠ‚åˆ°ç›®å½•
        subsections = section.get("subsections", [])
        if subsections:
            toc_html += '<ul class="toc-sublist">\n'
            for j, subsection in enumerate(subsections, 1):
                subsection_title = subsection.get("title", "")
                toc_html += f'<li><a href="#subsection-{i}-{j}" class="toc-sublink">{i}.{j} {escape(subsection_title)}</a></li>\n'
            toc_html += '</ul>\n'
            
    toc_html += '</ul>\n</div>\n'
    
    # ç”Ÿæˆå„ç« èŠ‚å†…å®¹
    for i, section in enumerate(sections, 1):
        title = section.get("title", "")
        charts = section.get("charts", [])
        summary = section.get("summary", "")
        subsections = section.get("subsections", [])
        
        # åˆ›å»ºå­ç« èŠ‚æ ‡é¢˜åˆ°å›¾è¡¨çš„æ˜ å°„
        subsection_charts = {}
        for chart_item in charts:
            if isinstance(chart_item, dict):
                if chart_item.get("is_chart_group", False):
                    group_charts = chart_item.get("charts", [])
                    if group_charts and len(group_charts) > 0:
                        subsection_title = group_charts[0].get("subsection_title", "")
                        if subsection_title:
                            if subsection_title not in subsection_charts:
                                subsection_charts[subsection_title] = []
                            subsection_charts[subsection_title].append(chart_item)
                else:
                    subsection_title = chart_item.get("subsection_title", "")
                    if subsection_title:
                        if subsection_title not in subsection_charts:
                            subsection_charts[subsection_title] = []
                        subsection_charts[subsection_title].append(chart_item)
        
        # æ·»åŠ ä»ä¸Šä¸€ä¸ªç« èŠ‚åˆ°å½“å‰ç« èŠ‚çš„è¿‡æ¸¡æ–‡æœ¬ï¼ˆä»…ä»ç¬¬äºŒä¸ªç« èŠ‚å¼€å§‹ï¼‰
        if i > 1 and section.get("intro_text"):
            intro_text = section.get("intro_text", "")
            panels_html += f'''
            <div class="section-transition">
                <p>{escape(intro_text)}</p>
            </div>
            '''
        
        # ç« èŠ‚é¢æ¿å¼€å§‹
        panels_html += f'''
        <div id="section-{i}" class="section-panel">
            <div class="section-header">
                <div class="section-number">{i}</div>
                <h2 class="section-title">{escape(title)}</h2>
                <div class="section-actions">
                    <button class="section-action" title="æŠ˜å ç« èŠ‚" onclick="toggleSection(this)"><i class="icon">â–¼</i></button>
                </div>
            </div>
            <div class="section-content">
        '''
        
        # æ·»åŠ å­ç« èŠ‚å†…å®¹åŠå¯¹åº”çš„å›¾è¡¨
        for j, subsection in enumerate(subsections, 1):
            subsection_title = subsection.get("title", "")
            subsection_content = subsection.get("content", [])
            
            panels_html += f'''
            <div id="subsection-{i}-{j}" class="subsection-panel">
                <h3 class="subsection-title">{escape(subsection_title)}</h3>
                <div class="subsection-content">
            '''
            
            # æ·»åŠ å­ç« èŠ‚æ­£æ–‡
            if subsection_content:
                for paragraph in subsection_content:
                    panels_html += f'<p>{escape(paragraph)}</p>\n'
                    
            panels_html += '</div>\n'
        
            # æ·»åŠ è¯¥å­ç« èŠ‚å¯¹åº”çš„å›¾è¡¨
            if subsection_title in subsection_charts:
                for chart_item in subsection_charts[subsection_title]:
                    # ç¡®å®šå›¾è¡¨ç±»å‹å¹¶å¤„ç†
                    if isinstance(chart_item, dict) and chart_item.get("is_chart_group", False):
                        # å¤„ç†å›¾è¡¨ç»„
                        group_charts = chart_item.get("charts", [])
                        group_caption = chart_item.get("group_caption", "")
                        
                        # æ‹†åˆ†å…³é”®ç‚¹
                        key_points = []
                        if group_caption:
                            # å°è¯•ä»captionä¸­æå–key points
                            lines = group_caption.split('\n')
                            for line in lines:
                                line = line.strip()
                                if 'key point' in line.lower():
                                    key_points.append(line)
                        
                        print(f"ç”Ÿæˆå›¾è¡¨ç»„æ¨¡æ¿ï¼ŒåŒ…å« {len(group_charts)} ä¸ªå›¾è¡¨, caption: '{group_caption[:50]}...'")
                        
                        # å¤„ç†ç»„æ ‡é¢˜ - åªæœ‰å½“group_captionä¸æ˜¯å®Œå…¨ç”±key pointsç»„æˆæ—¶æ‰è®¾ç½®
                        group_title = ""
                        
                        # æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šæ ¼å¼çš„å›¾è¡¨ç»„æ ‡é¢˜ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ˜¾ç¤ºæ ‡é¢˜
                        if group_caption.startswith("å›¾è¡¨ç»„:"):
                            group_title = ""  # å°†æ ‡é¢˜è®¾ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºæ ‡é¢˜æ¡
                        else:
                            # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¡Œéƒ½æ˜¯key points
                            all_key_points = True
                            non_empty_lines = [line.strip() for line in group_caption.split('\n') if line.strip()]
                            for line in non_empty_lines:
                                if 'key point' not in line.lower():
                                    all_key_points = False
                                    break
                            
                            if not all_key_points:
                                # å¦‚æœä¸æ˜¯å…¨éƒ¨æ˜¯key pointsï¼Œå°è¯•æ‰¾ä¸€ä¸ªékey pointçš„è¡Œä½œä¸ºæ ‡é¢˜
                                for line in group_caption.split('\n'):
                                    if 'key point' not in line.lower() and line.strip():
                                        group_title = line.strip()
                                        break
                        
                        # åˆ›å»ºå›¾è¡¨ç»„å®¹å™¨
                        panels_html += f'''
                        <div class="chart-group">
                        '''
                        
                        # åªæœ‰å½“æœ‰ç»„æ ‡é¢˜æ—¶æ‰æ·»åŠ æ ‡é¢˜åŒºåŸŸ
                        if group_title:
                            panels_html += f'''
                            <div class="chart-group-header">
                                <h4 class="chart-group-title">{escape(group_title)}</h4>
                            </div>
                            '''
                        
                        panels_html += f'''
                            <div class="chart-group-container">
                                <div class="chart-group-grid chart-group-{len(group_charts)}">
                        '''
                        
                        # æ·»åŠ ç»„å†…æ‰€æœ‰å›¾è¡¨
                        for group_chart in group_charts:
                            img = group_chart.get("img", "")
                            alt_text = group_chart.get("alt_text", "å›¾è¡¨")
                            is_vegalite = group_chart.get("is_vegalite", False)
                            
                            panels_html += '<div class="chart-group-item">\n'
                            
                            # è·å–ç›¸å¯¹è·¯å¾„
                            relative_img_path = convert_to_relative_path(img)
                            
                            if is_vegalite:
                                chart_id = group_chart.get("chart_id", "")
                                print(f"  æ·»åŠ Vega-Liteå›¾è¡¨: {chart_id}, å›¾ç‰‡å¤‡ç”¨: {relative_img_path}")
                                panels_html += f'<div class="chart-wrapper"><div id="{chart_id}" data-fallback="{relative_img_path}" class="chart-container"></div></div>\n'
                            else:
                                # ä½¿ç”¨ç¼–ç åçš„ç›¸å¯¹è·¯å¾„
                                panels_html += f'<div class="chart-wrapper"><img src="{relative_img_path}" alt="{escape(alt_text)}"></div>\n'
                            
                            panels_html += '</div>\n'
                        
                        # ç»“æŸå›¾è¡¨ç»„ç½‘æ ¼
                        panels_html += '</div>\n'
                        
                        # å¦‚æœæœ‰å…³é”®ç‚¹ï¼Œæ·»åŠ å…³é”®ç‚¹åˆ—è¡¨
                        if key_points:
                            panels_html += '<div class="key-points-container">\n'
                            panels_html += '<h4 class="key-points-title">Key Points</h4>\n'
                            panels_html += '<ul class="key-points-list">\n'
                            for point in key_points:
                                # ç§»é™¤"key point1: "ç­‰å‰ç¼€
                                point_text = re.sub(r'^key point\d+:\s*', '', point)
                                panels_html += f'<li class="key-point">{highlight_keywords(point_text)}</li>\n'
                            panels_html += '</ul>\n'
                            panels_html += '</div>\n'
                        
                        # å…³é—­å›¾è¡¨ç»„å®¹å™¨ (åªå…³é—­å¿…è¦çš„æ ‡ç­¾)
                        panels_html += '</div>\n</div>\n'
                    
                    elif isinstance(chart_item, dict):
                        # å¤„ç†å•ä¸ªå›¾è¡¨
                        caption = chart_item.get("caption", "")
                        img = chart_item.get("img", "")
                        alt_text = chart_item.get("alt_text", "å›¾è¡¨")
                        is_vegalite = chart_item.get("is_vegalite", False)
                        
                        # æ‹†åˆ†å…³é”®ç‚¹
                        key_points = []
                        if caption:
                            # å°è¯•ä»captionä¸­æå–key points
                            lines = caption.split('\n')
                            for line in lines:
                                line = line.strip()
                                if 'key point' in line.lower():
                                    key_points.append(line)
                        
                        # å¤„ç†æ ‡é¢˜
                        chart_title = ""
                        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¡Œéƒ½æ˜¯key points
                        all_key_points = True
                        non_empty_lines = [line.strip() for line in caption.split('\n') if line.strip()]
                        for line in non_empty_lines:
                            if 'key point' not in line.lower():
                                all_key_points = False
                                break
                        
                        if not all_key_points:
                            # å¦‚æœä¸æ˜¯å…¨éƒ¨æ˜¯key pointsï¼Œå°è¯•æ‰¾ä¸€ä¸ªékey pointçš„è¡Œä½œä¸ºæ ‡é¢˜
                            for line in caption.split('\n'):
                                if 'key point' not in line.lower() and line.strip():
                                    chart_title = line.strip()
                                    break
                        
                        panels_html += f'''
                        <div class="chart-single">
                        '''
                        
                        # åªæœ‰å½“æœ‰æ ‡é¢˜æ—¶æ‰æ·»åŠ æ ‡é¢˜åŒºåŸŸ
                        if chart_title:
                            panels_html += f'''
                            <div class="chart-single-header">
                                <h4 class="chart-single-title">{escape(chart_title)}</h4>
                            </div>
                            '''
                        
                        panels_html += f'''
                            <div class="chart-single-container">
                        '''
                        
                        # æ·»åŠ å›¾è¡¨
                        panels_html += '<div class="chart-wrapper">\n'
                        if is_vegalite:
                            chart_id = chart_item.get("chart_id", "")
                            print(f"  æ·»åŠ å•ä¸ªVega-Liteå›¾è¡¨: {chart_id}, å›¾ç‰‡å¤‡ç”¨: {img}")
                            panels_html += f'<div id="{chart_id}" data-fallback="{img}" class="chart-container"></div>\n'
                        else:
                            # ä½¿ç”¨ç¼–ç åçš„ç›¸å¯¹è·¯å¾„
                            relative_img_path = convert_to_relative_path(img)
                            panels_html += f'<img src="{relative_img_path}" alt="{escape(alt_text)}">\n'
                        panels_html += '</div>\n'
                        
                        # æ·»åŠ å…³é”®ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
                        if key_points:
                            panels_html += '<div class="key-points-container">\n'
                            panels_html += '<h4 class="key-points-title">Key Points</h4>\n'
                            panels_html += '<ul class="key-points-list">\n'
                            for point in key_points:
                                # ç§»é™¤"key point1: "ç­‰å‰ç¼€
                                point_text = re.sub(r'^key point\d+:\s*', '', point)
                                panels_html += f'<li class="key-point">{highlight_keywords(point_text)}</li>\n'
                            panels_html += '</ul>\n'
                            panels_html += '</div>\n'
                        
                        panels_html += '</div>\n</div>\n'
            
            # å…³é—­å­ç« èŠ‚é¢æ¿
            panels_html += '</div>\n'
        
        # å¤„ç†æœªå…³è”åˆ°å­ç« èŠ‚çš„å›¾è¡¨
        orphan_charts = []
        for chart_item in charts:
            if isinstance(chart_item, dict):
                if chart_item.get("is_chart_group", False):
                    group_charts = chart_item.get("charts", [])
                    if not group_charts or len(group_charts) == 0 or not group_charts[0].get("subsection_title", ""):
                        orphan_charts.append(chart_item)
                elif not chart_item.get("subsection_title", ""):
                    orphan_charts.append(chart_item)
        
        # æ·»åŠ æ²¡æœ‰å­ç« èŠ‚çš„ç‹¬ç«‹å›¾è¡¨
        if orphan_charts:
            for chart_item in orphan_charts:
                if isinstance(chart_item, dict):
                    if not chart_item.get("is_chart_group", False):
                        # å¤„ç†å•ä¸ªå›¾è¡¨
                        caption = chart_item.get("caption", "")
                        img = chart_item.get("img", "")
                        alt_text = chart_item.get("alt_text", "å›¾è¡¨")
                        is_vegalite = chart_item.get("is_vegalite", False)
                        
                        # æ‹†åˆ†å…³é”®ç‚¹
                        key_points = []
                        if caption:
                            # å°è¯•ä»captionä¸­æå–key points
                            lines = caption.split('\n')
                            for line in lines:
                                line = line.strip()
                                if 'key point' in line.lower():
                                    key_points.append(line)
                        
                        # å¤„ç†æ ‡é¢˜
                        chart_title = ""
                        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¡Œéƒ½æ˜¯key points
                        all_key_points = True
                        non_empty_lines = [line.strip() for line in caption.split('\n') if line.strip()]
                        for line in non_empty_lines:
                            if 'key point' not in line.lower():
                                all_key_points = False
                                break
                        
                        if not all_key_points:
                            # å¦‚æœä¸æ˜¯å…¨éƒ¨æ˜¯key pointsï¼Œå°è¯•æ‰¾ä¸€ä¸ªékey pointçš„è¡Œä½œä¸ºæ ‡é¢˜
                            for line in caption.split('\n'):
                                if 'key point' not in line.lower() and line.strip():
                                    chart_title = line.strip()
                                    break
                        
                        panels_html += f'''
                        <div class="chart-single">
                        '''
                        
                        # åªæœ‰å½“æœ‰æ ‡é¢˜æ—¶æ‰æ·»åŠ æ ‡é¢˜åŒºåŸŸ
                        if chart_title:
                            panels_html += f'''
                            <div class="chart-single-header">
                                <h4 class="chart-single-title">{escape(chart_title)}</h4>
                            </div>
                            '''
                        
                        panels_html += f'''
                            <div class="chart-single-container">
                        '''
                        
                        # æ·»åŠ å›¾è¡¨
                        panels_html += '<div class="chart-wrapper">\n'
                        if is_vegalite:
                            chart_id = chart_item.get("chart_id", "")
                            print(f"  æ·»åŠ å•ä¸ªVega-Liteå›¾è¡¨: {chart_id}, å›¾ç‰‡å¤‡ç”¨: {img}")
                            panels_html += f'<div id="{chart_id}" data-fallback="{img}" class="chart-container"></div>\n'
                        else:
                            # ä½¿ç”¨ç¼–ç åçš„ç›¸å¯¹è·¯å¾„
                            relative_img_path = convert_to_relative_path(img)
                            panels_html += f'<img src="{relative_img_path}" alt="{escape(alt_text)}">\n'
                        panels_html += '</div>\n'
                        
                        # æ·»åŠ å…³é”®ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
                        if key_points:
                            panels_html += '<div class="key-points-container">\n'
                            panels_html += '<h4 class="key-points-title">Key Points</h4>\n'
                            panels_html += '<ul class="key-points-list">\n'
                            for point in key_points:
                                # ç§»é™¤"key point1: "ç­‰å‰ç¼€
                                point_text = re.sub(r'^key point\d+:\s*', '', point)
                                panels_html += f'<li class="key-point">{highlight_keywords(point_text)}</li>\n'
                            panels_html += '</ul>\n'
                            panels_html += '</div>\n'
                        
                        panels_html += '</div>\n</div>\n'
        
        # æ·»åŠ ç« èŠ‚æ€»ç»“ï¼ˆç§»åŠ¨åˆ°ç« èŠ‚æœ€æœ«å°¾ï¼‰
        if summary:
            panels_html += f'''
            <div id="section-{i}-summary" class="section-summary">
                <h3 class="summary-title">Summary</h3>
                <div class="summary-content">
                    <p>{highlight_keywords(summary)}</p>
                </div>
            </div>
            '''
        
        # ç»“æŸç« èŠ‚
        panels_html += '</div>\n</div>\n'
    
    # ç”Ÿæˆå®Œæ•´HTML
    css = get_css()
    js = get_js()
    vegalite_script = generate_vegalite_script(chart_configs)
    
    html = f'''<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†ææŠ¥å‘Š</title>
    <style>
    {css}
    </style>
    <!-- Vega & Vega-Lite -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.25.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.16.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.22.2"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>æ•°æ®åˆ†ææŠ¥å‘Š</h1>
            <div class="header-controls">
                <button id="expandAllBtn">å±•å¼€å…¨éƒ¨</button>
                <button id="collapseAllBtn">æŠ˜å å…¨éƒ¨</button>
                <button id="printBtn">æ‰“å°æŠ¥å‘Š</button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            {toc_html}
        </aside>
        
        <main class="content">
            {instruction_html}
            
            {abstract_html}
            
            <div class="panels-container">
                {panels_html}
            </div>
        </main>
    </div>
    
    <script>
    {js}
    </script>
    
    <!-- Vega-Liteå›¾è¡¨åˆå§‹åŒ– -->
    <script>
    {vegalite_script}
    </script>
</body>
</html>'''
    
    return html

def get_css():
    """è·å–CSSæ ·å¼"""
    return '''
    :root {
        --primary-color: #4169E1;
        --primary-light: #E6ECFF;
        --secondary-color: #6495ED;
        --accent-color: #1E90FF;
        --text-color: #333;
        --light-bg: #f9f9f9;
        --border-color: #ddd;
        --shadow-color: rgba(0,0,0,0.1);
        --success-color: #4CAF50;
        --info-color: #2196F3;
        --warning-color: #FF9800;
        --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --transition-speed: 0.3s;
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: var(--font-main);
        line-height: 1.6;
        color: var(--text-color);
        background-color: var(--light-bg);
        padding-top: 60px;
        overflow-x: hidden;
    }
    
    a {
        color: var(--accent-color);
        text-decoration: none;
    }
    
    a:hover {
        text-decoration: underline;
    }
    
    /* å¤´éƒ¨æ ·å¼ */
    header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 2px 4px var(--shadow-color);
        z-index: 1000;
        height: 60px;
        display: flex;
        align-items: center;
    }
    
    .header-content {
        width: 100%;
        max-width: 1600px;  /* åŒ¹é…å®¹å™¨æœ€å¤§å®½åº¦ */
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .header-controls button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 12px;
        margin-left: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color var(--transition-speed);
    }
    
    .header-controls button:hover {
        background-color: var(--secondary-color);
    }
    
    /* å®¹å™¨å¸ƒå±€ */
    .container {
        display: flex;
        max-width: 1600px;  /* å¢åŠ æœ€å¤§å®½åº¦ */
        margin: 0 auto;
        min-height: calc(100vh - 120px);
        padding: 0 20px;
    }
    
    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
        width: 15%;  /* å‡å°ä¾§è¾¹æ å®½åº¦ */
        min-width: 180px;
        max-width: 220px;  /* é™åˆ¶æœ€å¤§å®½åº¦ */
        background-color: white;
        box-shadow: 0 1px 3px var(--shadow-color);
        position: sticky;
        top: 60px;
        height: calc(100vh - 60px);
        overflow-y: auto;
        padding: 20px 0;
        z-index: 900;
    }
    
    /* ä¸»å†…å®¹åŒºåŸŸ */
    .content {
        flex: 1;
        padding: 20px 20px 20px 40px;  /* å¢åŠ å·¦ä¾§å†…è¾¹è· */
        overflow-x: hidden;
        min-width: 0;  /* é˜²æ­¢å†…å®¹æº¢å‡º */
        width: 85%;  /* å¢åŠ å†…å®¹åŒºåŸŸå®½åº¦ */
    }
    
    /* ç›®å½•æ ·å¼ */
    .toc-container {
        padding: 0 15px 20px;
    }
    
    .toc-container h3 {
        font-size: 18px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .toc-list {
        list-style-type: none;
    }
    
    .toc-link {
        display: block;
        padding: 8px 0;
        color: var(--text-color);
        font-weight: 500;
        transition: color var(--transition-speed);
    }
    
    .toc-link:hover {
        color: var(--accent-color);
    }
    
    .toc-sublist {
        list-style-type: none;
        margin-left: 15px;
    }
    
    .toc-sublink {
        display: block;
        padding: 6px 0;
        color: var(--text-color);
        font-size: 14px;
        transition: color var(--transition-speed);
    }
    
    .toc-sublink:hover {
        color: var(--accent-color);
    }
    
    /* æç¤ºå¡ç‰‡ */
    .instruction-card {
        display: flex;
        background-color: white;
        border-radius: 6px;
        margin-bottom: 30px;
        padding: 15px;
        box-shadow: 0 1px 3px var(--shadow-color);
    }
    
    .instruction-icon {
        font-size: 24px;
        margin-right: 15px;
        color: var(--info-color);
    }
    
    .instruction-content h3 {
        margin-bottom: 8px;
        color: var(--info-color);
    }
    
    .query-text {
        font-size: 16px;
        font-weight: 500;
        color: var(--primary-color);
        background-color: var(--primary-light);
        padding: 10px 15px;
        border-radius: 4px;
        margin: 8px 0;
        border-left: 3px solid var(--primary-color);
    }
    
    /* ç« èŠ‚æ ·å¼ */
    .section-panel {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px var(--shadow-color);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .section-header {
        padding: 15px 20px;
        background-color: white;
        border-bottom: 2px solid var(--primary-color);
        color: var(--text-color);
        display: flex;
        align-items: center;
        position: relative;
    }
    
    .section-number {
        background-color: var(--primary-color);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
    }
    
    .section-title {
        flex: 1;
        font-size: 20px;
        font-weight: 500;
        color: var(--primary-color);
    }
    
    .section-actions {
        position: absolute;
        right: 20px;
        top: 15px;
    }
    
    .section-action {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 16px;
    }
    
    .section-content {
        padding: 20px;
    }
    
    /* å­ç« èŠ‚æ ·å¼ */
    .subsection-panel {
        margin-bottom: 25px;
    }
    
    .subsection-title {
        font-size: 18px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        color: var(--secondary-color);
    }
    
    .subsection-content p {
        margin-bottom: 15px;
    }
    
    /* è¿‡æ¸¡æ–‡æœ¬ */
    .section-transition {
        padding: 15px 0;
        margin-bottom: 20px;
        color: var(--text-color);
        font-style: italic;
        border-bottom: 1px dashed var(--border-color);
    }
    
    /* å›¾è¡¨ç»„ */
    .chart-group {
        background-color: white;
        border-radius: 6px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px var(--shadow-color);
    }
    
    .chart-group-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .chart-group-title {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
        color: var(--secondary-color);
    }
    
    .chart-group-container {
        padding: 15px;
        width: 100%;
        overflow: visible;
    }
    
    .chart-group-grid {
        display: grid;
        gap: 20px;
        width: 100%;
    }
    
    .chart-group-1 {
        grid-template-columns: 1fr;
    }
    
    .chart-group-2 {
        grid-template-columns: repeat(2, minmax(500px, 1fr));  /* å¢åŠ æœ€å°å®½åº¦ */
    }
    
    .chart-group-3 {
        grid-template-columns: repeat(3, minmax(400px, 1fr));  /* å¢åŠ æœ€å°å®½åº¦ */
    }
    
    .chart-group-4 {
        grid-template-columns: repeat(2, minmax(500px, 1fr));  /* å¢åŠ æœ€å°å®½åº¦ */
    }
    
    /* å•ä¸ªå›¾è¡¨ */
    .chart-single {
        background-color: white;
        border-radius: 6px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px var(--shadow-color);
    }
    
    .chart-single-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .chart-single-title {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
        color: var(--secondary-color);
    }
    
    .chart-single-container {
        padding: 15px;
    }
    
    /* å›¾è¡¨å®¹å™¨ */
    .chart-wrapper {
        width: 100%;
        margin-bottom: 15px;
        overflow: visible;
        border-radius: 4px;
        min-height: 450px;
    }
    
    .chart-wrapper img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .chart-container {
        width: 100%;
        min-height: 450px;
        position: relative;
        overflow: visible !important;
    }
    
    /* ç¡®ä¿çƒ­åŠ›å›¾æ­£ç¡®æ˜¾ç¤º */
    #vegalite_chart_6 {
        min-height: 500px !important;
        height: 500px !important;
    }
    
    /* ç¡®ä¿Vega-Liteå›¾è¡¨æ­£ç¡®æ˜¾ç¤º */
    .vega-embed {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: visible !important;
    }
    
    .vega-embed .vega-actions {
        position: absolute;
        top: -40px;
        right: 0;
        z-index: 1000;
    }
    
    /* å…³é”®ç‚¹æ ·å¼ */
    .key-points-container {
        padding: 15px;
        margin-top: 15px;
        border-top: 1px solid var(--border-color);
    }
    
    .key-points-title {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 12px;
        color: var(--secondary-color);
    }
    
    .key-points-list {
        list-style-type: none;
    }
    
    .key-point {
        position: relative;
        padding-left: 20px;
        margin-bottom: 10px;
    }
    
    .key-point:before {
        content: "â€¢";
        position: absolute;
        left: 0;
        color: var(--accent-color);
        font-weight: bold;
    }
    
    /* ç« èŠ‚æ€»ç»“æ ·å¼ */
    .section-summary {
        padding: 20px 0;
        margin-top: 25px;
        border-top: 1px dashed var(--border-color);
    }
    
    .summary-title {
        font-size: 18px;
        margin-bottom: 12px;
        color: var(--primary-color);
    }
    
    .summary-content {
        color: var(--text-color);
    }
    
    /* å…³é”®è¯é«˜äº® */
    .highlight, .keyword {
        color: var(--accent-color);
        font-weight: 500;
    }
    
    /* é¡µè„šæ ·å¼ */
    footer {
        background-color: white;
        color: var(--text-color);
        padding: 20px 0;
        border-top: 1px solid var(--border-color);
    }
    
    .footer-content {
        max-width: 1600px;  /* åŒ¹é…å®¹å™¨æœ€å¤§å®½åº¦ */
        margin: 0 auto;
        text-align: center;
        padding: 0 20px;
        color: #777;
        font-size: 14px;
    }
    
    /* å“åº”å¼æ ·å¼ */
    @media (max-width: 1400px) {
        .chart-group-2, .chart-group-3, .chart-group-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 992px) {
        .container {
            flex-direction: column;
            padding: 0 10px;
        }
        
        .sidebar {
            width: 100%;
            max-width: none;
            position: static;
            height: auto;
            margin-bottom: 20px;
        }
        
        .content {
            width: 100%;
            padding: 20px;
        }
        
        .chart-group-2, .chart-group-3, .chart-group-4 {
            grid-template-columns: 1fr;
        }
    }
    
    /* æ‰“å°æ ·å¼ */
    @media print {
        body {
            padding-top: 0;
        }
        
        header, .sidebar, footer, .section-actions {
            display: none;
        }
        
        .container {
            display: block;
        }
        
        .content {
            width: 100%;
            padding: 0;
        }
        
        .section-panel {
            break-inside: avoid;
            margin-bottom: 30px;
            box-shadow: none;
            border: 1px solid #ddd;
        }
    }
    
    /* æ‘˜è¦å®¹å™¨ */
    .abstract-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px var(--shadow-color);
        margin-bottom: 30px;
        padding: 25px;
        border-left: 4px solid var(--success-color);
    }
    
    .abstract-title {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--success-color);
        display: flex;
        align-items: center;
    }
    
    .abstract-title:before {
        content: "ğŸ“‹";
        margin-right: 10px;
        font-size: 20px;
    }
    
    .abstract-content {
        color: var(--text-color);
        line-height: 1.7;
    }
    
    .abstract-content p {
        margin: 0;
        font-size: 16px;
    }
    '''

def get_js():
    """è·å–JavaScriptè„šæœ¬"""
    return '''
    // æŠ˜å å±•å¼€åŠŸèƒ½
    function toggleSection(button) {
        const section = button.closest('.section-panel');
        const content = section.querySelector('.section-content');
        const icon = button.querySelector('.icon');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = 'â–¼';
            button.setAttribute('title', 'æŠ˜å ç« èŠ‚');
        } else {
            content.style.display = 'none';
            icon.textContent = 'â–º';
            button.setAttribute('title', 'å±•å¼€ç« èŠ‚');
        }
    }
    
    // æŠ˜å å…¨éƒ¨ç« èŠ‚
    document.getElementById('collapseAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.section-content').forEach(content => {
            content.style.display = 'none';
            const icon = content.parentElement.querySelector('.section-actions .icon');
            if (icon) icon.textContent = 'â–º';
        });
    });
    
    // å±•å¼€å…¨éƒ¨ç« èŠ‚
    document.getElementById('expandAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.section-content').forEach(content => {
            content.style.display = 'block';
            const icon = content.parentElement.querySelector('.section-actions .icon');
            if (icon) icon.textContent = 'â–¼';
        });
    });
    
    // æ‰“å°åŠŸèƒ½
    document.getElementById('printBtn').addEventListener('click', function() {
        window.print();
    });
    
    // å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
    document.querySelectorAll('.toc-link, .toc-sublink').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 80,
                    behavior: 'smooth'
                });
                
                // ç¡®ä¿ç›®æ ‡ç« èŠ‚å±•å¼€
                const sectionPanel = targetElement.closest('.section-panel');
                if (sectionPanel) {
                    const content = sectionPanel.querySelector('.section-content');
                    const icon = sectionPanel.querySelector('.section-actions .icon');
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        if (icon) icon.textContent = 'â–¼';
                    }
                }
            }
        });
    });
    
    // åˆå§‹åŒ–æ—¶å±•å¼€æ‰€æœ‰ç« èŠ‚
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.section-content').forEach(content => {
            content.style.display = 'block';
        });
    });
    '''

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Generate styled report from Markdown.')
    parser.add_argument('markdown_file', type=str, help='Path to the input Markdown file')
    parser.add_argument('--output', type=str, default='report_generated.html', help='Output HTML file name')
    parser.add_argument('--template', type=str, choices=['dashboard', 'article'], default='dashboard', help='Template style to use')
    parser.add_argument('--query', type=str, default='', help='User query to display in the report')
    args = parser.parse_args()

    # è·å–è¾“å…¥æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
    md_path = os.path.abspath(args.markdown_file)
    
    if not os.path.exists(md_path):
        print(f"é”™è¯¯: æ‰¾ä¸åˆ°è¾“å…¥æ–‡ä»¶ {md_path}")
        exit(1)
    
    # ç¡®å®šè¾“å‡ºè·¯å¾„ - å¦‚æœæœªæŒ‡å®šç›®å½•ï¼Œåˆ™æ”¾åœ¨ä¸markdownåŒä¸€ç›®å½•
    output_path = args.output
    if not os.path.dirname(output_path):
        md_dir = os.path.dirname(md_path)
        output_path = os.path.join(md_dir, output_path)
    
    try:
        print(f"å¼€å§‹è§£æå¹¶ç”ŸæˆæŠ¥å‘Š...")
        print(f"è¾“å…¥æ–‡ä»¶: {md_path}")
        print(f"è¾“å‡ºæ–‡ä»¶: {output_path}")
        print(f"ä½¿ç”¨æ¨¡æ¿: {args.template}")
        if args.query:
            print(f"ç”¨æˆ·æŸ¥è¯¢: {args.query}")
        
        # è§£æMarkdownæ–‡ä»¶
        sections, query_from_title, report_abstract = parse_markdown(md_path)
        
        if not sections:
            print("è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•ç« èŠ‚æ•°æ®ã€‚è¯·æ£€æŸ¥Markdownæ–‡ä»¶æ ¼å¼ã€‚")
            exit(1)
            
        # ç»Ÿè®¡å›¾è¡¨å’Œå›¾è¡¨ç»„æ•°é‡
        total_charts = 0
        total_groups = 0
        
        for section in sections:
            for chart in section.get("charts", []):
                if isinstance(chart, dict) and chart.get("is_chart_group", False):
                    total_groups += 1
                    total_charts += len(chart.get("charts", []))
                else:
                    total_charts += 1
        
        print(f"è§£æç»“æœ: {len(sections)}ä¸ªç« èŠ‚, {total_charts}ä¸ªå›¾è¡¨, {total_groups}ä¸ªå›¾è¡¨ç»„")
        
        # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„æŸ¥è¯¢ï¼šä¼˜å…ˆä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨ä»markdownæ ‡é¢˜ä¸­æå–çš„æŸ¥è¯¢
        final_query = args.query if args.query else query_from_title
        if query_from_title and not args.query:
            print(f"ä»markdownæ ‡é¢˜ä¸­æå–åˆ°æŸ¥è¯¢: {query_from_title}")
        
        # ç”ŸæˆHTMLå†…å®¹
        print("ç”ŸæˆHTMLæŠ¥å‘Š...")
        html = fill_template(sections, args.template, final_query, report_abstract)
    
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        output_dir = os.path.dirname(output_path)
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # å†™å…¥HTMLæ–‡ä»¶
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(html)
    
        print(f"âœ… æŠ¥å‘Šå·²æˆåŠŸç”Ÿæˆ: {output_path}")
        print(f"  - åŒ…å« {len(sections)} ä¸ªç« èŠ‚")
        print(f"  - åŒ…å« {total_charts} ä¸ªå›¾è¡¨ ({total_groups} ä¸ªå›¾è¡¨ç»„)")
        print(f"  - ä½¿ç”¨äº† {args.template} æ¨¡æ¿")
        
    except Exception as e:
        print(f"âŒ ç”ŸæˆæŠ¥å‘Šæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
        import traceback
        traceback.print_exc()
        exit(1)
