import json
import re
import traceback
import os
from storyteller.llm_call.openai_llm import call_openai
from storyteller.llm_call.prompt_factory import get_prompt
from typing import Dict, Any

def extract_json_from_text(text):
    """ä»æ–‡æœ¬ä¸­æå–JSONå¯¹è±¡"""
    try:
        # é¦–å…ˆå°è¯•ç›´æ¥å°†æ•´ä¸ªæ–‡æœ¬è§£æä¸ºJSON
        return json.loads(text)
    except json.JSONDecodeError:
        # å¦‚æœå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾JSONå—
        json_match = re.search(r'```(?:json)?\s*([\s\S]*?)\s*```', text)
        if json_match:
            try:
                json_str = json_match.group(1).strip()
                return json.loads(json_str)
            except:
                pass
                
        # å°è¯•æŸ¥æ‰¾æ‹¬å·åŒ…å›´çš„JSONå¯¹è±¡
        json_match = re.search(r'(\{[\s\S]*\})', text)
        if json_match:
            try:
                return json.loads(json_match.group(1))
            except:
                pass
                
        print(f"âŒ æ— æ³•ä»æ–‡æœ¬ä¸­æå–JSON: {text[:100]}...")
        return None

def get_prompt_content(template_name, template_args):
    """ç›´æ¥è¯»å–æ¨¡æ¿æ–‡ä»¶å¹¶æ›¿æ¢å…¶ä¸­çš„å˜é‡ï¼Œé¿å…Pythonçš„å­—ç¬¦ä¸²æ ¼å¼åŒ–é—®é¢˜"""
    # è·å–æ¨¡æ¿æ–‡ä»¶è·¯å¾„
    template_path = os.path.join("storyteller", "templates", f"{template_name}.txt")
    
    # è¯»å–æ¨¡æ¿å†…å®¹
    try:
        with open(template_path, 'r', encoding='utf-8') as f:
            template_content = f.read()
    except Exception as e:
        print(f"âŒ è¯»å–æ¨¡æ¿æ–‡ä»¶å¤±è´¥: {str(e)}")
        return None
    
    # æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
    for key, value in template_args.items():
        placeholder = "{" + key + "}"
        template_content = template_content.replace(placeholder, str(value))
    
    return template_content

def evaluate_report(
    dataset_context: str, 
    query: str, 
    md_report: str, 
    report_image: str = None,
    llm_kwargs: Dict[str, Any] = None,
    max_retries: int = 3
) -> float:
    """
    è¯„ä¼°æ•°æ®å¯è§†åŒ–æŠ¥å‘Šè´¨é‡
    
    å‚æ•°:
        dataset_context: æ•°æ®é›†ä¸Šä¸‹æ–‡
        query: ç”¨æˆ·æŸ¥è¯¢
        md_report: æŠ¥å‘ŠMarkdownå†…å®¹
        report_image: æŠ¥å‘Šæˆªå›¾çš„base64ç¼–ç ï¼ˆå¯é€‰ï¼Œä½†å½“å‰å®ç°ä¸ä½¿ç”¨ï¼‰
        llm_kwargs: LLMè°ƒç”¨å‚æ•°
        max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
    
    è¿”å›:
        float: åŠ æƒè¯„åˆ† (0-10åˆ†)
    """
    # æ„å»ºæç¤ºè¯ï¼ˆåœ¨é‡è¯•å¾ªç¯å¤–å‡†å¤‡ï¼Œé¿å…é‡å¤æ„å»ºï¼‰
    prompt_args = {
        "DATASET_CONTEXT": dataset_context,
        "QUERY": query,
        "REPORT": md_report,
        "REPORT_IMAGE": ""  # ä¸åŒ…å«å›¾åƒ
    }
    
    # ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°è·å–æ¨¡æ¿å†…å®¹ï¼Œé¿å…æ ¼å¼åŒ–é—®é¢˜
    prompt = get_prompt_content("report_evaluation", prompt_args)
    if not prompt:
        print("âŒ è·å–æ¨¡æ¿å†…å®¹å¤±è´¥")
        return 5.0  # é»˜è®¤ä¸­ç­‰åˆ†æ•°
        
    # é‡è¯•æœºåˆ¶
    for attempt in range(max_retries):
        try:
            if attempt == 0:
                print("ğŸ“ ä½¿ç”¨é€šç”¨APIè¿›è¡ŒæŠ¥å‘Šè¯„ä¼°...")
            else:
                print(f"ğŸ”„ ç¬¬{attempt + 1}æ¬¡é‡è¯•æŠ¥å‘Šè¯„ä¼°...")
            
            # è°ƒç”¨APIè¿›è¡Œè¯„ä¼°
            responses = call_openai(prompt, **(llm_kwargs or {}))
            if not responses:
                print("âš ï¸ APIæœªè¿”å›æœ‰æ•ˆå“åº”")
                if attempt == max_retries - 1:  # æœ€åä¸€æ¬¡å°è¯•
                    return 5.0  # é»˜è®¤ä¸­ç­‰åˆ†æ•°
                continue
                
            response_text = responses[0].strip()
            print("âœ… æˆåŠŸè·å–è¯„ä¼°å“åº”")
            
            # è¾“å‡ºåŸå§‹å“åº”ï¼Œæ–¹ä¾¿è°ƒè¯•
            print(f"\nğŸ“ è¯„ä¼°å“åº”(æˆªå–å‰200å­—ç¬¦):\n{response_text[:200]}...")
            
            # å¤„ç†å¯èƒ½çš„markdownæ ¼å¼
            if response_text.startswith("```json"):
                response_text = response_text.replace("```json", "").replace("```", "")
            elif response_text.startswith("```"):
                response_text = response_text.replace("```", "")
            response_text = response_text.strip()
            
            # å°è¯•è§£æJSON
            result = None
            
            # é¦–å…ˆå°è¯•ç›´æ¥è§£æJSON
            try:
                result = json.loads(response_text)
            except json.JSONDecodeError:
                # å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œä½¿ç”¨å¢å¼ºçš„JSONæå–æ–¹æ³•
                print("âš ï¸ ç›´æ¥JSONè§£æå¤±è´¥ï¼Œå°è¯•æå–JSON...")
                result = extract_json_from_text(response_text)
                
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£æJSON
            if not result:
                print(f"âŒ ç¬¬{attempt + 1}æ¬¡å°è¯•ï¼šæ— æ³•ä»å“åº”ä¸­æå–æœ‰æ•ˆJSON")
                if attempt == max_retries - 1:  # æœ€åä¸€æ¬¡å°è¯•
                    print("âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é»˜è®¤åˆ†æ•°")
                    return 5.0  # é»˜è®¤ä¸­ç­‰åˆ†æ•°
                continue  # ç»§ç»­é‡è¯•
            
            # éªŒè¯æ‰€æœ‰å¿…è¦çš„é”®æ˜¯å¦å­˜åœ¨
            required_keys = ["informativeness", "clarity_coherence", "visualization_quality", "narrative_quality"]
            missing_keys = [key for key in required_keys if key not in result]
            if missing_keys:
                print(f"âŒ ç¬¬{attempt + 1}æ¬¡å°è¯•ï¼šç¼ºå°‘å¿…è¦çš„è¯„ä¼°ç»´åº¦: {missing_keys}")
                if attempt == max_retries - 1:  # æœ€åä¸€æ¬¡å°è¯•
                    print("âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é»˜è®¤åˆ†æ•°")
                    return 5.0  # é»˜è®¤ä¸­ç­‰åˆ†æ•°
                continue  # ç»§ç»­é‡è¯•
            
            # ç¡®ä¿è¯„åˆ†æ˜¯æ•°å€¼ç±»å‹
            try:
                for key in required_keys:
                    if not isinstance(result[key]["score"], (int, float)):
                        result[key]["score"] = float(result[key]["score"])
            except (ValueError, TypeError, KeyError) as e:
                print(f"âŒ ç¬¬{attempt + 1}æ¬¡å°è¯•ï¼šè¯„åˆ†è½¬æ¢ä¸ºæ•°å€¼æ—¶å‡ºé”™: {str(e)}")
                if attempt == max_retries - 1:  # æœ€åä¸€æ¬¡å°è¯•
                    print("âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é»˜è®¤åˆ†æ•°")
                    return 5.0
                continue  # ç»§ç»­é‡è¯•
                
            # å¦‚æœåˆ°è¿™é‡Œï¼Œè¯´æ˜è§£ææˆåŠŸ
            print(f"âœ… ç¬¬{attempt + 1}æ¬¡å°è¯•æˆåŠŸè§£æJSON")
            
            # è®¡ç®—åŠ æƒåˆ†æ•° - æ‰€æœ‰ç»´åº¦æƒé‡ç›¸ç­‰ (25%)
            weighted_score = (
                0.25 * result["informativeness"]["score"] +
                0.25 * result["clarity_coherence"]["score"] +
                0.25 * result["visualization_quality"]["score"] +
                0.25 * result["narrative_quality"]["score"]
            )
            
            # æ‰“å°è¯„ä¼°ç»“æœ
            print("\nğŸ“Š æŠ¥å‘Šè¯„ä¼°ç»“æœ:")
            print(f"- ä¿¡æ¯ä¸°å¯Œåº¦ (25%): {result['informativeness']['score']}/10")
            print(f"  ç†ç”±: {result['informativeness']['rationale'][:200]}...")
            
            print(f"\n- æ¸…æ™°åº¦ä¸è¿è´¯æ€§ (25%): {result['clarity_coherence']['score']}/10")
            print(f"  ç†ç”±: {result['clarity_coherence']['rationale'][:200]}...")
            
            print(f"\n- å¯è§†åŒ–è´¨é‡ (25%): {result['visualization_quality']['score']}/10")
            print(f"  ç†ç”±: {result['visualization_quality']['rationale'][:200]}...")
            
            print(f"\n- å™äº‹è´¨é‡ (25%): {result['narrative_quality']['score']}/10")
            print(f"  ç†ç”±: {result['narrative_quality']['rationale'][:200]}...")
            
            print(f"\nâœ¨ åŠ æƒæ€»åˆ†: {weighted_score:.2f}/10")
            
            return round(weighted_score, 2)
            
        except Exception as e:
            print(f"âŒ ç¬¬{attempt + 1}æ¬¡å°è¯•å‡ºé”™: {str(e)}")
            if attempt == max_retries - 1:  # æœ€åä¸€æ¬¡å°è¯•
                print("âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é»˜è®¤åˆ†æ•°")
                traceback.print_exc()  # æ‰“å°è¯¦ç»†é”™è¯¯å †æ ˆ
                return 5.0
            # ç»§ç»­é‡è¯•
    
    # ç†è®ºä¸Šä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼Œä½†ä½œä¸ºå®‰å…¨ä¿éšœ
    return 5.0
    